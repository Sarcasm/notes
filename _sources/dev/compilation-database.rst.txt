
********************
Compilation database
********************

.. contents::
   :local:


What is a compilation database?
===============================

A compilation database is a database for compile options.
It records which compile options are used to build the files in a project.
A compilation database can be, but is not limited to,
a `JSON Compilation Database`_.
Refer to the `clang::tooling::CompilationDatabase`_ class
for the full interface.

A real-world JSON Compilation Database *entry*, generated by CMake,
looks like this:

.. code-block:: json

    {
      "directory": "/home/user/dev/llvm/build",
      "file": "/home/user/dev/llvm/llvm/lib/Support/APFloat.cpp",
      "command": "/usr/bin/clang++ -DGTEST_HAS_RTTI=0 -D_DEBUG -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -Ilib/Support -I/home/user/dev/llvm/llvm/lib/Support -Iinclude -I/home/user/dev/llvm/llvm/include -fPIC -fvisibility-inlines-hidden -Wall -W -Wno-unused-parameter -Wwrite-strings -Wcast-qual -Wmissing-field-initializers -pedantic -Wno-long-long -Wcovered-switch-default -Wnon-virtual-dtor -Wdelete-non-virtual-dtor -Werror=date-time -std=c++11 -fcolor-diagnostics -ffunction-sections -fdata-sections -O3 -UNDEBUG -fno-exceptions -fno-rtti -o lib/Support/CMakeFiles/LLVMSupport.dir/APFloat.cpp.o -c /home/user/dev/llvm/llvm/lib/Support/APFloat.cpp"
    }

An entry generated by ``clang -MJ``, looks like this:

.. code-block:: json

   {
     "directory": "/home/user/dev/llvm/build",
     "file": "/tmp/foo.cpp",
     "output": "foo.o",
     "arguments": ["/usr/bin/clang-5.0", "-xc++", "/tmp/foo.cpp", "--driver-mode=g++", "-Wall", "-I", "/home/user/dev/libcpp/libcpp/include", "-c", "--target=x86_64-unknown-linux-gnu"]
   }


.. note:: A good introduction to compilation databases
          is available on Eli Bendersky's blog:

          * `Compilation databases for Clang-based tools`_


What is it good for?
====================

You might wonder what a compilation database is good for.
This section list a various tools that may benefit from a compilation database.


Clang tools
-----------

`Core Clang tools`_ and `extra Clang tools`_:

* `clang-check <http://clang.llvm.org/docs/ClangCheck.html>`_
* `clang-include-fixer <http://clang.llvm.org/extra/include-fixer.html>`_
* `clang-rename <http://clang.llvm.org/extra/clang-rename.html>`_
* `clang-tidy <http://clang.llvm.org/extra/clang-tidy>`_
* `clangd <https://clang.llvm.org/extra/clangd.html>`_


A few other tools seems to be available,
but they aren't officially documented:

* ``clang-refactor``
* ``clang-reorder-fields``
* ``clang-change-namespace``
* ``clang-move``

.. seealso::

   * Some of these tools are demoed in the following blog post:
     `Improving workflow by using Clang-based tools
     <https://omtcyfz.github.io/2016/08/30/Improving-workflow-by-using-Clang-based-tools.html>`_

   * `clang-refactor's design document
     <https://docs.google.com/document/d/1w9IkR0_Gqmd5w4CZ2t_ZDZrNLYVirQPyMS41533HQZE/edit?usp=sharing>`_


Text editors and IDEs
---------------------

To bring basic IDE-like features to text editor you need 2 things:

1. text editor plugin which integrates libclang_
2. a compilation database, to feed to libclang_

With this, you can have features such as semantic code completion
and on-the-fly syntax checking.


LSP
^^^

LSP stands for Language Server Protocol,
see `Microsoft/language-server-protocol on Github <https://github.com/Microsoft/language-server-protocol>`_.

* https://github.com/jacobdufault/cquery
* `clangd <https://clang.llvm.org/extra/clangd.html>`_


Atom
^^^^

* https://github.com/AtomLinter/linter-clang
* https://github.com/joeroback/atom-clang


GNU Emacs
^^^^^^^^^

* https://github.com/abingham/emacs-ycmd
* https://github.com/Andersbakken/rtags
* https://github.com/kumar8600/flycheck-clangcheck
* https://github.com/randomphrase/ede-compdb
* https://github.com/Sarcasm/irony-mode


Vim
^^^

* http://valloric.github.io/YouCompleteMe
* https://github.com/Rip-Rip/clang_complete
* https://github.com/jeaye/color_coded


Other tools
-----------

* scan-build_, the Clang Static Analyzer CLI,
  generates and uses a compilation databases.

* `Ericsson/codechecker <codechecker_>`_ generates
  and uses compilation dabatases.

* Include What You Use: https://github.com/include-what-you-use/include-what-you-use

* OCLint: http://docs.oclint.org/en/stable/manual/oclint-json-compilation-database.html

* With little effort the Kythe_ indexer can be run on a compilation database.

* Clang's LibTooling_ based tools:

  * `clang-expand <https://github.com/goldsborough/clang-expand>`_

* `PVS-Studio on Linux <http://www.viva64.com/en/m/0036/>`_ [#pvs-studio-linux-compdb]_

* `cc_driver.pl`_ from the `Mo' Static <http://btorpey.github.io/blog/2016/04/07/mo-static/>`_
  article.

* `Sourcetrail <https://www.sourcetrail.com>`_

* `CLion <https://www.jetbrains.com/clion/>`_

.. seealso::

   Some of the tools listed here:

   * http://clang.llvm.org/docs/ExternalClangExamples.html


How to generate a JSON Compilation Database?
============================================

.. contents::
   :local:


Build systems and compilers
---------------------------

This section describes build tools which natively support
the generation of a compilation database.

Bazel
^^^^^

Google/Kythe as an experimental_action_listener to produce a compilation database:

- `github.com/google/kythe: tools/cpp/generate_compilation_database.sh <https://github.com/google/kythe/blob/cb58e9b4b5ee911db9495b382c9fe50e936f2bb3/tools/cpp/generate_compilation_database.sh>`_

There is also `bazel-compilation-database <https://github.com/grailbio/bazel-compilation-database>`_,
which is faster, easier to setup and does not require a full build,
at the cost of being less accurate.

Clang
^^^^^

Clang's `-MJ option <https://clang.llvm.org/docs/ClangCommandLineReference.html#cmdoption-clang-mj>`_
generates a compilation database entry per input (requires ``Clang >= 5.0``).

Usage::

  clang++ -MJ a.o.json -Wall -std=c++11 -o a.o -c a.cpp
  clang++ -MJ b.o.json -Wall -std=c++11 -o b.o -c b.cpp

To merge the compilation database entries into a valid compilation database,
it is possible to use ``sed``::

  sed -e '1s/^/[\n/' -e '$s/,$/\n]/' *.o.json > compile_commands.json

This ``sed`` invocation does the following:

* insert the opening bracket: ``[``
* concatenate the entries
* remove the trailing comma of the last entry (to be JSON compliant)
* insert the closing bracket: ``]``


CMake
^^^^^

To generate a JSON compilation database with CMake_,
enable the `CMAKE_EXPORT_COMPILE_COMMANDS`_ option
(requires ``CMake >= 2.8.5``).

For example, in an existing build directory, type::

  cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON .

This will create a file name ``compile_commands.json`` in the build directory.


Ninja
^^^^^

To generate a JSON compilation database with Ninja_,
use the `-t compdb`_ option (requires ``Ninja >= 1.2``).
This option takes a list of rules as argument.

Usage::

  ninja -t compdb [RULES...]

This works well with projects containing one rule for C++ files,
such as Ninja_ itself::

  ninja -t compdb cxx > compile_commands.json

However, it gets ugly if the Ninja build files contains a lot of rules.
You have to find a way to get a list of all the rules.
For example,
as of version 3.6.1,
CMake generates a lot of rules.
To generate a compilation database of Clang using CMake's Ninja generator
(``cmake -G Ninja <...>``)::

  ninja -t compdb $(awk '/^rule (C|CXX)_COMPILER__/ { print $2 }' rules.ninja) > compile_commands.json

This method is not ideal,
the ``awk`` line is not really good parser for Ninja syntax.
To make things better,
there is an issue on the ninja bug tracker with an associated pull request:

* https://github.com/ninja-build/ninja/issues/1024
* https://github.com/ninja-build/ninja/pull/1025


Qbs
^^^

`qbs <https://doc.qt.io/qbs/>`_ natively support
the generation of a compilation database.

Usage::

  qbs generate --generator clangdb


waf
^^^

`waf <https://waf.io>`_ supports the generation of
a JSON Compilation database by adding the following lines to the wfscript::

  def configure(conf):
      conf.load('compiler_cxx')
      ...
      conf.load('clang_compilation_database')


Specialized tools
-----------------

Some build systems do not support generating a compilation database.

A non-exhaustive list, includes:

* the GNU Build System (autotools): ``./configure`` and friends
* KBuild, the Linux Kernel Makefiles

For this reason, a few tools have emerged to respond to this issue.


bear and intercept-build
^^^^^^^^^^^^^^^^^^^^^^^^

Bear_ and `intercept-build` from scan-build_,
are two tools from `László Nagy`_,
that collects the compile options by intercepting calls to the compiler
during the build.
To have a complete compilation database a full build is required.

The scan-build_ tools is included in Clang tree since release 3.8.0,
as a replacement of the Perl implementation of ``scan-build``.
It's reasonable to think that someday, distributions will offer it as package.
``scan-build`` can already be easily be installed with pip_::

  pip install scan-build

Usage::

  <bear|intercept-build> BUILD_COMMAND

Example::

  bear make -B -j9
  intercept-build ./build.sh

A file named ``compile_commands.json`` is created in the current directory.


cdcd
^^^^

The `cdcc <https://github.com/gicmo/cdcc>`_ uses a compiler wrapper
to write an sqlite3 database,
from which ``compile_commands.json`` files can be generated.

The tools can be used to generate a compilation database
for the `JHBuild tool <https://developer.gnome.org/jhbuild/>`_.

.. seealso::

   * https://christian.kellner.me/2017/03/28/emacs-as-c-ide-and-jhbuild/


CodeChecker log
^^^^^^^^^^^^^^^

The `ld logger`_ tool from codechecker_
has an implementation of a build interceptor
similar to `bear and intercept-build`_.

They favor ``intercept-build`` [#codechecker-intercept-build]_ when available,
but fallback to the `ld logger`_ tool when needed.

The ld logger tool can be invoked with a build command,
for example::

  CodeChecker log -o compile_commands.json -b "make -B"

Howewer, in version 5.6, the resulting compilation database is surprising:

- Escaping of double quotes is not handled properly,
  for example it produces::

    -DIRONY_PACKAGE_VERSION=\"0.2.2-cvs\"

  instead of::

    -DIRONY_PACKAGE_VERSION=\\\"0.2.2-cvs\\\"

- There are compile commands not only for the compilation step,
  but also for linking::

    {
            "directory": "/home/user/build-irony/src",
            "command": "c++ -I<...> ...Irony.cpp.o ...main.cpp.o -o ...irony-server <ldflags...>",
            "file": "/home/user/build-irony/srcCMakeFiles/irony-server.dir/Irony.cpp.o"
    }


Luckily, with ``intercept-build``, these issues are fixed.


compdb
^^^^^^

compdb_ is a tool to manipulate compilation databases.
It can generate a compilation database for header files.


compiledb-generator
^^^^^^^^^^^^^^^^^^^

`compiledb-generator <https://github.com/nickdiego/compiledb-generator>`_
is a tool to generate compilation database for make-based build systems.
It works by parsing the output of commands like ``make --dry-run``.

Usage::

  compiledb-make all > compile_commands.json

To parse an existing build log::

  compiledb-parser . < build-log.txt

There is also a specialized command ``compiledb-aosp``,
to deal with `AOSP <https://source.android.com/>`_.


Sourcetrail Extension for Visual Studio
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The `Sourcetrail Extension`_ for Visual Studio is a GUI tool that generates
JSON Compilation Databases from VS Solutions.
A wide range of VS versions seems to be supported.


sw-btrace
^^^^^^^^^

sourceweb_\ 's btrace_ tool, aka ``sw-btrace``, use the same principle as `bear and intercept-build`_.

The generation is done in 2 steps:

1. Run ``sw-btrace BUILD_COMMAND`` to log the compilation.
2. Call ``sw-btrace-to-compiledb`` to generate a JSON compilation database
   out of the compilation log.

Example::

  sw-btrace make -B
  sw-btrace-to-compiledb

A file named ``compile_commands.json`` is created in the current directory.


tee3/commands_to_compilation_database
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

`tee3/commands_to_compilation_database <https://github.com/tee3/commands_to_compilation_database>`_
can generate compilation databases for Boost.Build, ``make``,
and a potentially other tools by mean of a regular expressions
to match the build output.

It also provides a tools to generate a compilation database
from files specified to the standard input,
and compile options specified on the command line.


xcpretty
^^^^^^^^

xcpretty_ can generate a compilation database for Xcode projects.
To do so, it uses the ``xcodebuild`` output.

Usage::

    xcodebuild | xcpretty -r json-compilation-database


Other compilation databases and tools
=====================================

This section shows that people invented their own compilation database version.
Either because no standards existed yet, or because of specialized needs.


cc_args.py
----------

The `cc_args.py`_ script
from the Vim plugin `clang_complete
<https://github.com/Rip-Rip/clang_complete>`_.

This script generates a `.clang_complete
<https://github.com/Rip-Rip/clang_complete/blob/c7f5673a5d31704e9ec43d43c0606b243d5ef623/doc/clang_complete.txt#L59-L87>`_
configuration file.

Usage::

  make CC='~/.vim/bin/cc_args.py gcc' CXX='~/.vim/bin/cc_args.py g++' -B


gccrec
------

The ``gccrec`` tool from the now unmaintained `gccsense
<https://github.com/m2ym/gccsense>`_ project.

The tool records the compile options in an SQLite database.

Links to the manual for reference:

* `txt <https://github.com/m2ym/gccsense/blob/67c76de401b3d11ccbba0e6d782c8686a341aabf/doc/manual.txt#L205-L252>`_
* `HTML <https://web.archive.org/web/20150223192059/http://cx4a.org/software/gccsense/manual.html#gccrec>`_


rtags
-----

The rtags_ project has a gcc wrapper named ``gcc-rtags-wrapper.sh``
to help feed its internal compilation database.

Description here:

* fixed link: https://github.com/Andersbakken/rtags/tree/499db6f98cc725bca66d122bce571adcdfa32187#setup
* latest: https://github.com/Andersbakken/rtags/#setup


YCM-Generator
-------------

YCM-Generator_ works differently than `bear and intercept-build`_.
It builds a project using a *fake toolchain*.
This is faster than doing a full build,
because the fake toolchain is composed of trivial programs.

The tool does not actually generate a "JSON Compilation Database",
instead it creates a configuration file for YouCompleteMe_.


Case studies on a few open source projects
==========================================

This section describes how to generate a compilation database
for a few open source projects.
Depending on the project,
the method to generate a compilation database can differ.

The result should preferrably be:

**correct**
  Some tools guess the compile options,
  if they guess wrong, the compile command entry is not useful.

**complete**
  A compilation database should be as exhaustive as possible.
  Any file on which a tool can be run on, need to have compile options.

  For example, a compilation database usually lacks compile options for headers,
  even though they would be useful to things like text editors.
  Or compile options for unit tests may not be available,
  if tests aren't built by default.

**fast**
  Between 2 or more correct and complete methods, one should favor the fastest.

  Tools that require a full project build to generate the database
  can easily become a hindrance on big projects.
  Imagine adding a new file to a big project.
  When you have to do a full rebuild
  just to make the file show up in the database,
  it's not pleasant.


git
---

git_ uses a custom Makefile and a ``configure`` scripts for the build.
The build system does not seem to have native support
for the compilation database generation.
We will use `bear and intercept-build`_ to generate one.

From a quick glimpse at the Makefile and documentation,
we can see there is a special ``DEVELOPER`` setting
to enable stricter compilation options.
This is used in this example to match the developer workflow better.

This example has been tested on git 2.9.2.

Compilation database generation with ``bear``::

  echo DEVELOPER=1 >> config.mak
  make configure
  bear make -j9

With ``intercept-build``, replace the last line by::

  intercept-build make -j9


.. rubric:: Footnotes

.. [#pvs-studio-linux-compdb] http://www.viva64.com/en/b/0446/#ID0EEAAC
.. [#codechecker-intercept-build] https://github.com/Ericsson/codechecker/blob/a83bcfde83c432b9b7ef5e99fae1745c91015fec/codechecker_lib/build_manager.py#L66-L85


.. _JSON Compilation Database: http://clang.llvm.org/docs/JSONCompilationDatabase.html
.. _`clang::tooling::CompilationDatabase`: http://clang.llvm.org/doxygen/classclang_1_1tooling_1_1CompilationDatabase.html
.. _Compilation databases for Clang-based tools: http://eli.thegreenplace.net/2014/05/21/compilation-databases-for-clang-based-tools
.. _libclang: http://clang.llvm.org/doxygen/group__CINDEX.html
.. _Core Clang tools: http://clang.llvm.org/docs/ClangTools.html
.. _extra Clang tools: http://clang.llvm.org/extra/index.html
.. _Kythe: https://www.kythe.io
.. _LibTooling: http://clang.llvm.org/docs/LibTooling.html
.. _cc_driver.pl: http://btorpey.github.io/pages/cc_driver.pl/index.html
.. _CMake: https://cmake.org
.. _CMAKE_EXPORT_COMPILE_COMMANDS: https://cmake.org/cmake/help/latest/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html
.. _Ninja: https://ninja-build.org
.. _-t compdb: https://ninja-build.org/manual.html#_extra_tools
.. _Bear: https://github.com/rizsotto/Bear
.. _scan-build: https://github.com/rizsotto/scan-build
.. _László Nagy: https://github.com/rizsotto
.. _pip: https://pip.pypa.io/en/stable/
.. _codechecker: https://github.com/Ericsson/codechecker
.. _ld logger: https://github.com/Ericsson/codechecker/tree/5ae34cf9f234225852debd3022afac2abadc9a64/external-source-deps/build-logger
.. _YCM-Generator: https://github.com/rdnetto/YCM-Generator
.. _YouCompleteMe: https://github.com/Valloric/YouCompleteMe
.. _rtags: https://github.com/Andersbakken/rtags
.. _sourceweb: https://github.com/rprichard/sourceweb
.. _Sourcetrail Extension: https://marketplace.visualstudio.com/items?itemName=vs-publisher-1208751.SourcetrailExtensino
.. _btrace: https://github.com/rprichard/sourceweb#btrace
.. _xcpretty: https://github.com/supermarin/xcpretty
.. _compdb: https://github.com/Sarcasm/compdb
.. _git: https://git-scm.com/
